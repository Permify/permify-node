name: Overwrite Proto Directory

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

permissions:
  contents: read

jobs:
  copy-proto:
    permissions:
      contents: write  # Required for pushing changes back to the repository
    runs-on: ubuntu-latest

    steps:
    # Security hardening for GitHub Actions runner
    - name: Harden Runner
      uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
      with:
        egress-policy: audit

    # Checkout the current repository
    - name: Checkout Repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    # Clone Permify repo and copy proto files to our repo
    - name: Copy Proto Files from Permify
      run: |
        git clone --depth=1 https://github.com/Permify/permify.git temp_dir
        rm -rf proto
        mkdir -p proto
        cp -r temp_dir/proto/* proto
        rm -rf temp_dir

    # Setup Node.js and install dependencies (including ts-proto)
    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    # Install Buf CLI using official action
    - name: Setup Buf
      uses: bufbuild/buf-action@v1
      with:
        setup_only: true

    # Generate TypeScript code from proto files
    - name: Generate Code with Buf
      run: buf generate

    # Commit generated files if there are any changes
    - name: Add and Commit Changes
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email '<>'
        git add src/grpc/generated proto/ package-lock.json
        if git diff-index --quiet HEAD; then
          echo "No changes to commit"
        else
          git commit -m "Update generated sdk directory with latest changes"
        fi

    # Push changes back to main branch
    - name: Push Changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git push origin main
